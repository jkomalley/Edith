{"version":3,"file":"render-blur.js","sourceRoot":"","sources":["../../../src/plugins/render-blur.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,UAAU,MAAM,SAAS,CAAA;AACrC,OAAO,KAAK,KAAK,MAAM,UAAU,CAAA;AAEjC,CAAC,GAAG,EAAE;IAEN,MAAM,IAAI,GAAG,MAAM,CAAA;IAsBnB,kBAAkB,IAAI;QACpB,MAAM,CAAC,UAAU,CAAC,cAAc,CAAC,IAAI,EAAE,IAAI,CAAc,CAAA;IAC3D,CAAC;IACD,mBAAmB,IAAI,EAAE,IAAI,EAAE,QAAQ;QACrC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,QAAQ,CAAA;IAC/B,CAAC;IAED,cAAc,CAAC,EAAE,IAAqB;QACpC,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAE5B,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,CAAC,CAAC,sCAAsC,CAAC,CAAA;QAC9E,KAAK,CAAC,OAAO,GAAG,KAAK,CAAC,OAAO,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,CAAA;QACjE,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,KAAK,IAAI,EAAE,CAAA;QAC/B,KAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,EAAE,cAAc,EAAE,GAAG,CAAC,EAAE,CAAC,CAAC,CAAA;QAClE,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,EAAE,eAAe,EAAE,IAAI,CAAC,SAAS,CAAC,EAAE,EAAE,CAAC,CAAA;QAChF,KAAK,CAAC,SAAS,GAAG,IAAI,CAAA;QACtB,KAAK,CAAC,OAAO,GAAG,CAAC,CAAC,SAAS,CAAC,IAAI,EAAE,SAAS,EAAE,KAAK,CAAC,CAAA;QAEnD,MAAM,KAAK,GAAG,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,CAAA;QACtC,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,CAAA;QACtF,MAAM,GAAG,GAAG,KAAK,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,EAAE,KAAK,CAAC,CAAA;QAE7D,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAA;QACrD,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,WAAW,CAAA;QACvD,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,CAAA;QAC5B,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;QACvD,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAA;IAClC,CAAC;IAED,iBAAiB,CAAC,EAAE,IAAI;QACtB,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAC5B,UAAU,CAAC,IAAI,CAAC,CAAA;QAChB,EAAE,CAAC,CAAC,KAAK,CAAC,OAAO,IAAI,IAAI,CAAC,CAAC,CAAC;YAC1B,IAAI,CAAC,IAAI,CAAC,CAAA;QACZ,CAAC;IACH,CAAC;IAED,oBAAoB,IAAqB;QACvC,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAC5B,MAAM,GAAG,GAAG,UAAU,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAA;QAE7C,0BAA0B;QAC1B,IAAI,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,GAAG,GAAG,CAAC,SAAS,CAAC,CAAA;QAC5C,oBAAoB;QACpB,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAA;QAE9C,KAAK,CAAC,KAAK,CAAC,OAAO,CAAC;YAClB,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,IAAI,EAAE,CAAC;YACP,IAAI,EAAE,KAAK,CAAC,SAAS,GAAG,KAAK,CAAC,QAAQ;YACtC,CAAC,EAAE,CAAC;YACJ,KAAK,EAAE,CAAC;SACT,CAAC,CAAA;IACJ,CAAC;IAED,MAAM,QAAQ,GAAG,EAAE,CAAA;IACnB,yBAAyB,MAAM;QAC7B,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAA;QACnB,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC;YAC1C,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC;gBACzB,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;YAClB,CAAC;QACH,CAAC;QACD,GAAG,CAAC,CAAC,MAAM,IAAI,IAAI,QAAQ,CAAC,CAAC,CAAC;YAC5B,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,CAAA;QACxB,CAAC;IACH,CAAC;IAED,cAAc,IAAqB;QACjC,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAC5B,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,CAAC,CAAC,EAAE,KAAK,CAAC,SAAS,CAAC,CAAA;IAC1E,CAAC;IAED,kBAAkB,IAAqB;QACrC,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAC5B,MAAM,CAAC,YAAY,CAAC,KAAK,CAAC,OAAO,CAAC,CAAA;QAClC,KAAK,CAAC,OAAO,GAAG,IAAI,CAAA;IACtB,CAAC;IAED,sBAAsB,MAAM,EAAE,CAAC;QAC7B,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,EAAE,GAAG,CAAC,CAAA;QACtD,MAAM,IAAI,GAAG,QAAQ,MAAM,KAAK,CAAA;QAChC,MAAM,CAAC,GAAG,CAAC;YACT,gBAAgB,EAAE,IAAI;YACtB,MAAM,EAAE,IAAI;SACb,CAAC,CAAA;IACJ,CAAC;IAED,oBAAoB,IAAqB,EAAE,KAAgB;QACzD,KAAK,CAAC,MAAM,CAAC,IAAI,EAAE,CAAA;QACnB,MAAM,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAA;QAClD,MAAM,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,IAAI,CAAC,WAAW,CAAA;QACnD,sCAAsC;IACxC,CAAC;IAED,mBAAmB,IAAqB,EAAE,KAAgB,EAAE,IAAc;QACxE,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC;YAAC,MAAM,CAAA;QAAC,CAAC;QAE/B,MAAM,KAAK,GAAG,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAA;QAC/E,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAA;QACzB,MAAM,MAAM,GAAG,KAAK,CAAC,MAAM,CAAA;QAC3B,EAAE,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;YAAC,MAAM,CAAA;QAAC,CAAC;QAEjC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAA;QACjC,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAA;QACnC,EAAE,CAAC,CAAC,KAAK,CAAC,QAAQ,KAAK,KAAK,CAAC,CAAC,CAAC;YAAC,MAAM,CAAA;QAAC,CAAC;QAExC,KAAK,CAAC,MAAM,CAAC,IAAI,EAAE,CAAA;QACnB,MAAM,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAA;QAClD,MAAM,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,IAAI,CAAC,WAAW,CAAA;QACnD,KAAK,CAAC,OAAO,CAAC,WAAW,GAAG,IAAI,CAAC,KAAK,CAAA;QACtC,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,YAAY,EAAE,MAAM,CAAC,aAAa,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAA;IACzH,CAAC;IAED,cAAc,IAAqB;QACjC,MAAM,KAAK,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAA;QAC5B,QAAQ,CAAC,IAAI,CAAC,CAAA;QACd,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;YACnB,MAAM,CAAA;QACR,CAAC;QAED,IAAI,CAAC,GAAG,CAAC,CAAA;QACT,UAAU,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;QACvB,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAA;QACtD,GAAG,CAAC,CAAC,MAAM,IAAI,IAAI,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;YAC/B,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,CAAA;YAC9C,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,EAAE,CAAC,CAAC,CAAA;YAC1C,SAAS,CAAC,IAAI,EAAE,KAAK,EAAE,IAAI,CAAC,CAAA;YAC5B,CAAC,IAAI,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,CAAC,CAAA;QAC1B,CAAC;QACD,EAAE,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;YAClB,YAAY,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,CAAC,CAAA;QAC/B,CAAC;QACD,eAAe,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;QAC5B,EAAE,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;YACvB,IAAI,CAAC,IAAI,CAAC,CAAA;QACZ,CAAC;IACH,CAAC;IAED,UAAU,CAAC,cAAc,CAAC,IAAI,EAAE;QAC9B,IAAI,EAAE,IAAI;QAEV,MAAM,EAAE,IAAI;QACZ,cAAc,EAAE,OAAO;KACxB,CAAC,CAAA;AAEF,CAAC,CAAC,EAAE,CAAA","sourcesContent":["import * as SpriteSpin from '../core'\nimport * as Utils from '../utils'\n\n(() => {\n\nconst NAME = 'blur'\n\ninterface BlurStep {\n  frame: number\n  lane: number\n  live: number\n  step: number\n  d: number\n  alpha: number\n}\ninterface BlurState {\n  canvas: any\n  context: CanvasRenderingContext2D\n  steps: BlurStep[]\n  fadeTime: number\n  frameTime: number\n  trackTime: number\n  cssBlur: boolean\n\n  timeout: number\n}\n\nfunction getState(data) {\n  return SpriteSpin.getPluginState(data, NAME) as BlurState\n}\nfunction getOption(data, name, fallback) {\n  return data[name] || fallback\n}\n\nfunction init(e, data: SpriteSpin.Data) {\n  const state = getState(data)\n\n  state.canvas = state.canvas || Utils.$(\"<canvas class='blur-layer'></canvas>\")\n  state.context = state.context || state.canvas[0].getContext('2d')\n  state.steps = state.steps || []\n  state.fadeTime = Math.max(getOption(data, 'blurFadeTime', 200), 1)\n  state.frameTime = Math.max(getOption(data, 'blurFrameTime', data.frameTime), 16)\n  state.trackTime = null\n  state.cssBlur = !!getOption(data, 'blurCss', false)\n\n  const inner = Utils.getInnerSize(data)\n  const outer = data.responsive ? Utils.getComputedSize(data) : Utils.getOuterSize(data)\n  const css = Utils.getInnerLayout(data.sizeMode, inner, outer)\n\n  state.canvas[0].width = data.width * data.canvasRatio\n  state.canvas[0].height = data.height * data.canvasRatio\n  state.canvas.css(css).show()\n  state.context.scale(data.canvasRatio, data.canvasRatio)\n  data.target.append(state.canvas)\n}\n\nfunction onFrame(e, data) {\n  const state = getState(data)\n  trackFrame(data)\n  if (state.timeout == null) {\n    loop(data)\n  }\n}\n\nfunction trackFrame(data: SpriteSpin.Data) {\n  const state = getState(data)\n  const ani = SpriteSpin.getPlaybackState(data)\n\n  // distance between frames\n  let d = Math.abs(data.frame - ani.lastFrame)\n  // shortest distance\n  d = d >= data.frames / 2 ? data.frames - d : d\n\n  state.steps.unshift({\n    frame: data.frame,\n    lane: data.lane,\n    live: 1,\n    step: state.frameTime / state.fadeTime,\n    d: d,\n    alpha: 0\n  })\n}\n\nconst toRemove = []\nfunction removeOldFrames(frames) {\n  toRemove.length = 0\n  for (let i = 0; i < frames.length; i += 1) {\n    if (frames[i].alpha <= 0) {\n      toRemove.push(i)\n    }\n  }\n  for (const item of toRemove) {\n    frames.splice(item, 1)\n  }\n}\n\nfunction loop(data: SpriteSpin.Data) {\n  const state = getState(data)\n  state.timeout = window.setTimeout(() => { tick(data) }, state.frameTime)\n}\n\nfunction killLoop(data: SpriteSpin.Data) {\n  const state = getState(data)\n  window.clearTimeout(state.timeout)\n  state.timeout = null\n}\n\nfunction applyCssBlur(canvas, d) {\n  const amount = Math.min(Math.max((d / 2) - 4, 0), 2.5)\n  const blur = `blur(${amount}px)`\n  canvas.css({\n    '-webkit-filter': blur,\n    filter: blur\n  })\n}\n\nfunction clearFrame(data: SpriteSpin.Data, state: BlurState) {\n  state.canvas.show()\n  const w = state.canvas[0].width / data.canvasRatio\n  const h = state.canvas[0].height / data.canvasRatio\n  // state.context.clearRect(0, 0, w, h)\n}\n\nfunction drawFrame(data: SpriteSpin.Data, state: BlurState, step: BlurStep) {\n  if (step.alpha <= 0) { return }\n\n  const specs = Utils.findSpecs(data.metrics, data.frames, step.frame, step.lane)\n  const sheet = specs.sheet\n  const sprite = specs.sprite\n  if (!sheet || !sprite) { return }\n\n  const src = data.source[sheet.id]\n  const image = data.images[sheet.id]\n  if (image.complete === false) { return }\n\n  state.canvas.show()\n  const w = state.canvas[0].width / data.canvasRatio\n  const h = state.canvas[0].height / data.canvasRatio\n  state.context.globalAlpha = step.alpha\n  state.context.drawImage(image, sprite.sampledX, sprite.sampledY, sprite.sampledWidth, sprite.sampledHeight, 0, 0, w, h)\n}\n\nfunction tick(data: SpriteSpin.Data) {\n  const state = getState(data)\n  killLoop(data)\n  if (!state.context) {\n    return\n  }\n\n  let d = 0\n  clearFrame(data, state)\n  state.context.clearRect(0, 0, data.width, data.height)\n  for (const step of state.steps) {\n    step.live = Math.max(step.live - step.step, 0)\n    step.alpha = Math.max(step.live - 0.25, 0)\n    drawFrame(data, state, step)\n    d += step.alpha + step.d\n  }\n  if (state.cssBlur) {\n    applyCssBlur(state.canvas, d)\n  }\n  removeOldFrames(state.steps)\n  if (state.steps.length) {\n    loop(data)\n  }\n}\n\nSpriteSpin.registerPlugin(NAME, {\n  name: NAME,\n\n  onLoad: init,\n  onFrameChanged: onFrame\n})\n\n})()\n"]}