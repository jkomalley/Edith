{"version":3,"file":"input-drag.js","sourceRoot":"","sources":["../../../src/plugins/input-drag.ts"],"names":[],"mappings":"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","sourcesContent":["import * as SpriteSpin from '../core'\n\n(() => {\n\nconst NAME = 'drag'\n\ninterface DragState {\n  startAt?: number\n  endAt?: number\n  frame?: number\n  lane?: number\n  wasPlaying?: boolean\n  minTime: number\n  maxTime: number\n}\n\nfunction getState(data: SpriteSpin.Data) {\n  return SpriteSpin.getPluginState(data, NAME) as DragState\n}\n\nfunction getAxis(data: SpriteSpin.Data) {\n  if (typeof data.orientation === 'number') {\n    return data.orientation * Math.PI / 180\n  }\n  if (data.orientation === 'horizontal') {\n    return 0\n  }\n  return Math.PI / 2\n}\n\nfunction onInit(e, data: SpriteSpin.Data) {\n  const state = getState(data)\n  const d = [200, 1500]\n  const t = data.touchScrollTimer || d\n  state.minTime = t[0] || d[0]\n  state.maxTime = t[1] || d[1]\n}\n\nfunction dragStart(e, data: SpriteSpin.Data) {\n  const state = getState(data)\n  if (data.loading || SpriteSpin.is(data, 'dragging') || data['zoomPinFrame'] && !data.stage.is(':visible')) {\n    return\n  }\n\n  // Touch scroll can only be disabled by cancelling the 'touchstart' event.\n  // If we would try to cancel the 'touchmove' event during a scroll\n  // chrome browser raises an error\n  //\n  // When a user interacts with sprite spin, we don't know whether the intention\n  // is to scroll the page or to roll the spin.\n  //\n  // On first interaction with SpriteSpin the scroll is not disabled\n  // On double tap within 200ms the scroll is not disabled\n  // Scroll is only disabled if there was an interaction with SpriteSpin in the past 1500ms\n\n  const now = new Date().getTime()\n  if (state.endAt && (now - state.endAt > state.maxTime)) {\n    // reset timer if the user has no interaction with spritespin within 1500ms\n    state.startAt = null\n    state.endAt = null\n  }\n  if (state.startAt && (now - state.startAt > state.minTime)) {\n    // disable scroll only if there was already an interaction with spritespin\n    // however, allow scrolling on double tab within 200ms\n    e.preventDefault()\n  }\n\n  state.startAt = now\n  state.wasPlaying = !!SpriteSpin.getPlaybackState(data).handler\n\n  state.frame = data.frame || 0\n  state.lane = data.lane || 0\n  SpriteSpin.flag(data, 'dragging', true)\n  SpriteSpin.updateInput(e, data)\n}\n\nfunction dragEnd(e, data: SpriteSpin.Data) {\n  if (SpriteSpin.is(data, 'dragging')) {\n    getState(data).endAt = new Date().getTime()\n    SpriteSpin.flag(data, 'dragging', false)\n    SpriteSpin.resetInput(data)\n    if (data.retainAnimate && getState(data).wasPlaying) {\n      SpriteSpin.startAnimation(data)\n    }\n  }\n}\n\nfunction drag(e, data: SpriteSpin.Data) {\n  const state = getState(data)\n  const input = SpriteSpin.getInputState(data)\n  if (!SpriteSpin.is(data, 'dragging')) { return }\n  SpriteSpin.updateInput(e, data)\n\n  const rad = getAxis(data)\n  const sn = Math.sin(rad)\n  const cs = Math.cos(rad)\n  const x = ((input.nddX * cs - input.nddY * sn) * data.sense) || 0\n  const y = ((input.nddX * sn + input.nddY * cs) * (data.senseLane || data.sense)) || 0\n\n  // accumulate\n  state.frame += data.frames * x\n  state.lane += data.lanes * y\n\n  // update spritespin\n  const oldFrame = data.frame\n  const oldLane = data.lane\n  SpriteSpin.updateFrame(data, Math.floor(state.frame), Math.floor(state.lane))\n  SpriteSpin.stopAnimation(data)\n}\n\nfunction mousemove(e, data) {\n  dragStart(e, data)\n  drag(e, data)\n}\n\nSpriteSpin.registerPlugin('drag', {\n  name: 'drag',\n  onInit: onInit,\n\n  mousedown: dragStart,\n  mousemove: drag,\n  mouseup: dragEnd,\n\n  documentmousemove: drag,\n  documentmouseup: dragEnd,\n\n  touchstart: dragStart,\n  touchmove: drag,\n  touchend: dragEnd,\n  touchcancel: dragEnd\n})\n\nSpriteSpin.registerPlugin('move', {\n  name: 'move',\n  onInit: onInit,\n\n  mousemove: mousemove,\n  mouseleave: dragEnd,\n\n  touchstart: dragStart,\n  touchmove: drag,\n  touchend: dragEnd,\n  touchcancel: dragEnd\n})\n\n})()\n"]}